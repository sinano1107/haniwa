rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 全てのアクセスをブロック
    match /{document=**} {
      allow read, write: if false;
    }

    function isAnyAuthenticated() {
      return request.auth.uid != null;
    }

    // groupsコレクション
    match /groups/{groupID} {
      function getGroup() {
        return get(/databases/$(database)/documents/groups/$(groupID))
      }

      allow update: if isAnyAuthenticated();

      allow read: if isAnyAuthenticated();

      match /members/{memberID} {
        allow create: if isAnyAuthenticated()
          && request.auth.uid in getGroup().data.members
          && (request.resource.data.point is number && request.resource.data.point == 0);
        
        allow update: if isAnyAuthenticated()
          && request.auth.uid in getGroup().data.members
          && request.auth.uid == memberID;
        
        allow read: if isAnyAuthenticated()
          && request.auth.uid in getGroup().data.members;
      }

      // クエストのスキーマ検証
      function isValidQuest(quest) {
        return quest.size() == 6
          && 'createdAt' in quest && quest.createdAt is timestamp
          && 'updatedAt' in quest && quest.updatedAt is timestamp
          && 'uid' in quest && quest.uid is string
          && 'name' in quest && quest.name is string
          && 'minutes' in quest && quest.minutes is number
          && 'point' in quest && quest.point is number;
      }

      match /quests/{questID} {
        allow read: if isAnyAuthenticated()
          && request.auth.uid in getGroup().data.members;

        allow create: if isAnyAuthenticated()
          && request.auth.uid in getGroup().data.members
          && isValidQuest(request.resource.data)
          && request.resource.data.createdAt == request.time // createdAtが現在時刻か
          && request.resource.data.createdAt == request.resource.data.updatedAt // updatedAtがcreatedAtと等しいか
          && request.resource.data.uid == request.auth.uid; // uidが本人のものか

        allow update: if isAnyAuthenticated()
          && request.auth.uid in getGroup().data.members
          && isValidQuest(request.resource.data)
          && request.resource.data.createdAt == resource.data.createdAt // createdAtが変更されないか
          && request.resource.data.updatedAt == request.time // updatedAtが現在時刻か
          && resource.data.uid == request.resource.data.uid // uidが変更されないか
          && resource.data.uid == request.auth.uid; // uidが本人のものか
      }

      match /tags/{tagID} {
        allow read: if isAnyAuthenticated()
          && request.auth.uid in getGroup().data.members;
      }
    }
  }
}